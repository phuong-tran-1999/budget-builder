<table
    mat-table
    [dataSource]="dataSource"
    class="table table--left-border table--editable table--cell-right"
    [formGroup]="form"
    [trackBy]="_trackByIndex"
    multiTemplateDataRows
>
    <ng-container matColumnDef="category">
        <th mat-header-cell *matHeaderCellDef>Category</th>
        <td
            mat-cell
            *matCellDef="let element; dataSource: dataSource"
            [class.editable]="element.type === 'category'"
            [attr.colspan]="element.type === 'categoryGroup' ? displayedColumns.length : 1"
        >
            @switch (element.type) { @case ('subTotals') { Sub Totals } @case ('category') {
            <mat-form-field appearance="outline" class="w-full inline-form-field">
                <input type="text" matInput [formControl]="element.name" placeholder="Category Name.." />
            </mat-form-field>
            } @case ('categoryGroup') {
            <mat-form-field appearance="outline" class="w-full inline-form-field">
                <input type="text" matInput [formControl]="element.name" placeholder="Parent Category Name.." />
            </mat-form-field>
            } }
        </td>
        <td mat-footer-cell *matFooterCellDef>Profit / Loss</td>
    </ng-container>

    @for (month of initialMonths; track $index) {
    <ng-container [matColumnDef]="month.value">
        <th mat-header-cell *matHeaderCellDef>{{ month.date | date: 'MMM yyyy' }}</th>
        <td
            mat-cell
            *matCellDef="let element; dataSource: dataSource"
            [class.editable]="element.type !== 'subTotals'"
            [class.hidden]="element.type === 'categoryGroup'"
            class="align-right"
        >
            @switch (element.type) { @case ('subTotals') { {{ element.subTotals.value[$index] }} } @case ('category') {
            <mat-form-field appearance="outline" class="w-full inline-form-field align-right">
                <input
                    type="text"
                    matInput
                    [formControl]="element.amounts.at($index)"
                    mask="separator.2"
                    [allowNegativeNumbers]="true"
                    [validation]="false"
                    (keydown.enter)="addCategory(element.categories)"
                />
            </mat-form-field>
            } @default {} }
        </td>
        <td mat-footer-cell *matFooterCellDef class="align-right">{{ form.value.total?.[$index] }}</td>
    </ng-container>
    }

    <ng-container matColumnDef="secondary">
        <td
            mat-cell
            [attr.colspan]="displayedColumns.length"
            *matCellDef="let element; dataSource: dataSource; let last = last"
        >
            <div class="flex items-center gap-2 text-gray-800 cursor-pointer opacity-60">
                <mat-icon class="icon-size-4.5">add</mat-icon>
                <span>Add New Parent Category</span>
            </div>
        </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    <tr
        mat-row
        *matRowDef="let row; columns: ['secondary']; let last = last"
        [class.hidden]="!last"
        (click)="addGroup()"
    ></tr>
    <tr mat-footer-row *matFooterRowDef="displayedColumns; sticky: true"></tr>
</table>
