<div class="h-full overflow-auto">
    <table class="table mat-mdc-table table--left-border table--editable table--cell-right">
        <thead>
            <tr class="mat-mdc-header-row">
                <th class="mat-mdc-header-cell">Category</th>
                @for (month of initialMonths; track $index) {
                    <th class="mat-mdc-header-cell">{{ month.date | date: 'MMM yyyy' }}</th>
                }
            </tr>
        </thead>
        <tbody>
            <!-- Income -->
            <tr class="mat-mdc-row">
                <td class="font-semibold mat-mdc-cell" [attr.colspan]="displayedColumns.length">Income</td>
            </tr>

            @for (parentCategory of form.controls.income.controls.groups.controls; track $index) {
                <tr class="mat-mdc-row">
                    <td class="mat-mdc-cell editable col-header-cell" [attr.colspan]="displayedColumns.length">
                        <mat-form-field appearance="outline" class="w-full inline-form-field">
                            <input
                                type="text"
                                matInput
                                [formControl]="parentCategory.controls.name"
                                placeholder="Parent Category Name.."
                                (keydown.control.enter)="addGroup('income')"
                            />
                        </mat-form-field>
                    </td>
                </tr>

                @for (category of parentCategory.controls.categories.controls; track $index) {
                    <tr class="mat-mdc-row">
                        <td class="mat-mdc-cell editable">
                            <mat-form-field appearance="outline" class="w-full inline-form-field">
                                <input
                                    type="text"
                                    matInput
                                    [formControl]="category.controls.name"
                                    placeholder="Category Name.."
                                    (keydown.enter)="addCategory(parentCategory.controls.categories)"
                                />
                            </mat-form-field>
                        </td>

                        @for (month of initialMonths; track $index) {
                            <td class="mat-mdc-cell editable">
                                <mat-form-field appearance="outline" class="w-full inline-form-field align-right">
                                    <input
                                        type="text"
                                        matInput
                                        [formControl]="category.controls.amounts.at($index)"
                                        mask="separator.2"
                                        [allowNegativeNumbers]="true"
                                        [validation]="false"
                                        (keydown.enter)="addCategory(parentCategory.controls.categories)"
                                    />
                                </mat-form-field>
                            </td>
                        }
                    </tr>
                }

                <tr class="mat-mdc-row">
                    <td class="mat-mdc-cell">Sub Totals</td>
                    @for (month of initialMonths; track $index) {
                        <td class="mat-mdc-cell align-right">{{ parentCategory.controls.subtotals.value[$index] }}</td>
                    }
                </tr>
            }

            <tr class="mat-mdc-row">
                <td class="mat-mdc-cell" [attr.colspan]="displayedColumns.length">
                    <div class="flex items-center gap-2 cursor-pointer opacity-60" (click)="addGroup('income')">
                        <mat-icon class="icon-size-4.5">add</mat-icon>
                        <span>Add New Parent Category</span>
                    </div>
                </td>
            </tr>

            <tr class="font-semibold mat-mdc-row">
                <td class="mat-mdc-cell col-header-cell">Total Income</td>
                @for (month of initialMonths; track $index) {
                    <td class="mat-mdc-cell align-right">{{ form.controls.income.controls.total.value[$index] }}</td>
                }
            </tr>

            <!-- Separator -->
            <tr class="mat-mdc-row custom-height">
                <td class="h-10 mat-mdc-cell editable" [attr.colspan]="displayedColumns.length + 1"></td>
            </tr>

            <!-- Expense -->
            <tr class="mat-mdc-row">
                <td class="font-semibold mat-mdc-cell col-header-cell" [attr.colspan]="displayedColumns.length">
                    Expense
                </td>
            </tr>

            @for (parentCategory of form.controls.expense.controls.groups.controls; track $index) {
                <tr class="mat-mdc-row">
                    <td class="mat-mdc-cell editable col-header-cell" [attr.colspan]="displayedColumns.length">
                        <mat-form-field appearance="outline" class="w-full inline-form-field">
                            <input
                                type="text"
                                matInput
                                [formControl]="parentCategory.controls.name"
                                placeholder="Parent Category Name.."
                                (keydown.control.enter)="addGroup('expense')"
                            />
                        </mat-form-field>
                    </td>
                </tr>

                @for (category of parentCategory.controls.categories.controls; track $index) {
                    <tr class="mat-mdc-row">
                        <td class="mat-mdc-cell editable">
                            <mat-form-field appearance="outline" class="w-full inline-form-field">
                                <input
                                    type="text"
                                    matInput
                                    [formControl]="category.controls.name"
                                    placeholder="Category Name.."
                                    (keydown.enter)="addCategory(parentCategory.controls.categories)"
                                />
                            </mat-form-field>
                        </td>

                        @for (month of initialMonths; track $index) {
                            <td class="mat-mdc-cell editable">
                                <mat-form-field appearance="outline" class="w-full inline-form-field align-right">
                                    <input
                                        type="text"
                                        matInput
                                        [formControl]="category.controls.amounts.at($index)"
                                        mask="separator.2"
                                        [allowNegativeNumbers]="true"
                                        [validation]="false"
                                        (keydown.enter)="addCategory(parentCategory.controls.categories)"
                                    />
                                </mat-form-field>
                            </td>
                        }
                    </tr>
                }

                <tr class="mat-mdc-row">
                    <td class="mat-mdc-cell">Sub Totals</td>
                    @for (month of initialMonths; track $index) {
                        <td class="mat-mdc-cell align-right">{{ parentCategory.controls.subtotals.value[$index] }}</td>
                    }
                </tr>

                <!-- @if (!$last) {
                    <tr class="mat-mdc-row custom-height">
                        <td class="h-4 mat-mdc-cell editable" [attr.colspan]="displayedColumns.length + 1"></td>
                    </tr>
                } -->
            }

            <tr class="mat-mdc-row">
                <td class="mat-mdc-cell col-header-cell" [attr.colspan]="displayedColumns.length">
                    <div class="flex items-center gap-2 cursor-pointer opacity-60" (click)="addGroup('expense')">
                        <mat-icon class="icon-size-4.5">add</mat-icon>
                        <span>Add New Parent Category</span>
                    </div>
                </td>
            </tr>

            <tr class="font-semibold mat-mdc-row">
                <td class="mat-mdc-cell col-header-cell">Total Expense</td>
                @for (month of initialMonths; track $index) {
                    <td class="mat-mdc-cell align-right">{{ form.controls.expense.controls.total.value[$index] }}</td>
                }
            </tr>

            <!-- Separator -->
            <tr class="mat-mdc-row custom-height">
                <td
                    class="h-10 mat-mdc-cell editable col-header-cell"
                    [attr.colspan]="displayedColumns.length + 1"
                ></td>
            </tr>

            <tr class="font-semibold mat-mdc-row">
                <td class="mat-mdc-cell col-header-cell">Profit / Loss</td>
                @for (month of initialMonths; track $index) {
                    <td class="mat-mdc-cell align-right">{{ form.controls.total.value[$index] }}</td>
                }
            </tr>
            <tr class="font-semibold mat-mdc-row">
                <td class="mat-mdc-cell col-header-cell">Opening Balance</td>
                @for (month of initialMonths; track $index) {
                    <td class="mat-mdc-cell align-right">{{ form.controls.total.value[$index] }}</td>
                }
            </tr>
            <tr class="font-semibold mat-mdc-row">
                <td class="mat-mdc-cell col-header-cell">Closing Balance</td>
                @for (month of initialMonths; track $index) {
                    <td class="mat-mdc-cell align-right">{{ form.controls.total.value[$index] }}</td>
                }
            </tr>
        </tbody>
    </table>

    <!-- Hacky way to get the mat-table css load -->
    <table mat-table class="hidden">
        <tr mat-header-row *matHeaderRowDef="[]"></tr>
        <tr mat-row *matRowDef="let row; columns: []"></tr>
    </table>
</div>
